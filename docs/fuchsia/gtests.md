# Deploying and running gtests on Fuchsia

[TOC]

Fuchsia gtest binaries are deployed and executed via scripts that are
automatically generated by the `test()` GN target. For each test, a wrapper
scripts is created named `run_<test_target_name>` for running the Fuchsia
package on the device. These executables are found in `${OUTPUT_DIR}/bin`.

The aforementioned devices can be either emulators started by the scripts
themselves, an existing emulator instance, or a physical device. To build a
gtest binary, check this [documentation](build_instructions.md).

For the sake of this example, we will be using `base_unittests` as the package
we wish to install and/or execute.

## Hermetic emulation

The test script brings up an emulator, runs the tests on it, and
shuts the emulator down when finished.
```bash
$ out/fuchsia/bin/run_base_unittests
```

The flag `--custom-image` can be used to specify the Fuchsia boot image used
by the emulator. For instance, setting
`--custom-image=workstation.qemu-x64-release` would run the test on a
workstation image.

## Run on a persistent device

You can also run tests on physical devices or start a persistent emulator
from the Chromium tree. To start a persistent emulator, run:

```bash
$ ./build/fuchsia/test/start_emulator.py
```

Part of the output should be:

```
2022-05-31 22:55:13,011:INFO:root:Emulator successfully started.\
 You can now run Chrome Fuchsia tests with\
 "--target-id fuchsia-emulator-198" to target this emulator.
```

You can run tests on persistent devices by adding the command line
arguments indicated above. For example, to run `base_unittests` you
would run the following command:

```bash
$ out/fuchsia/bin/run_base_unittests --target-id fuchsia-emulator-198
```

If only one Fuchsia device is connected, you can also simply use 

```bash
$ out/fuchsia/bin/run_base_unittests -d
```

## Run on a device paved with Fuchsia built from source

Make sure that the CPU architecture of your Chromium output directory matches
the architecture of the Fuchsia output directory (x64==x64, arm64==arm64, etc.).

```bash
$ out/fuchsia/bin/run_base_unittests -d --repo [FUCHSIA_OUT_DIR]/amber-files \
--no-repo-init
```

Note that you should not have `fx serve` running as Chromium will handle serving
the repository.

## Run on a device the host is connected to remotely via ssh

```bash
$ out/fuchsia/bin/run_base_unittests --target-id=[::1]:8022
```

## Troubleshooting a test

To troubleshoot a specific test, consider a combination of the following
arguments to the test runner script:

* `--gtest_filter="[TestSuite.TestName]"` to only run a specific test, or a
  comma-separated list to run a set of tests. Wildcards can also be used to run
  a set of tests or an entire test suite, e.g. `--gtest_filter="[TestSuite.*]"`.
* `--test-launcher-jobs=1` to only have one batch of tests running at a time.
  This bypasses the test launcher buffering of test log output, making it
  possible to access the log output from successful test runs.
* `--single-process-tests` to run all the tests in the same process. Unlike the
  above option, this will run the tests directly in the test launcher process,
  making it easier to attach a debugger.
* "--logs-dir=[/path/to/log/directory]` to specify the directory to write logs
  to. By default, Chromium logs are written to the "system_log" file in that
  directory.
* `--gtest_repeat=[number] --gtest_break_on_failure` to run a test or test suite
  a certain number of times until it fails. This is useful to investigate flaky
  tests.
